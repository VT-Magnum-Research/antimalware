#!/bin/bash
#
# collect-data-device.sh
# Installs, tests, and uninstalls apks for malware analysis on
# a specific device. 
#
# Brandon Amos
# 2012.09.15

source helper.sh
source flash-device.sh

function dev_adbTimeout {
    timeout 60 $ADB $@
    if [[ $? != 0 ]]; then
        msg "Command 'adbTimeout $@' timed out.
        Reflashing device and retrying"
        flashDevice "$SERIAL"
        $ADB $@
    fi
}

function dev_testBenign {
    COUNT=0;
    ls $MODE/partition$PARTITION/B*apk | while read APPLICATION; do
        if (( COUNT % 5 == 0  )); then # Not $COUNT
            flashDevice "$SERIAL"
        fi;

        monkeyTest $APPLICATION # $DELAY
        let COUNT=COUNT+1
    done
}

function dev_testMalicious {
    ls $MODE/partition$PARTITION/M*apk | while read APPLICATION; do
        flashDevice "$SERIAL"
        monkeyTest $APPLICATION # $DELAY
    done
}

#########
# Start #
#########

# [[ $1 == "Training" || $1 == "Testing" || $1 == "Remote" ]] || \
#    die 1 "Usage: ./collect-data-device.sh <Testing/Training> <serial number> <partition number>"

# dev_collect <Mode> <serial number> <partition number>
function dev_collect {
    msg Setting the mode to $1 for device $2
    MODE=$1
    SERIAL=$2
    PARTITION=$3

    ADB="adb -s $SERIAL "
    FASTBOOT="fastboot -s $SERIAL "
    ADBTIMEOUT="dev_adbTimeout"

    # msg Setting the event delay to 450 milliseconds
    # DELAY=450 # Random: $(( ($RANDOM % 1501) + 250 ))

    dev_testBenign
    dev_testMalicious

    flashDevice "$SERIAL"
    $ADB shell input keyevent $ADB_POWER
}
