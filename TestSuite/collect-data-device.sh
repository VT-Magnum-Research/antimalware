#!/bin/bash
#
# collect-data-device.sh
# Installs, tests, and uninstalls apks for malware analysis on
# a specific device. 
#
# Brandon Amos
# 2012.09.15

source helper.sh

function adbTimeout {
    timeout 20 $ADB $@
    if [[ $? != 0 ]]; then
        msg "Command 'adbTimeout $@' timed out.
        Reflashing device and retrying"
        ./flash-device.sh "$SERIAL"

        msg Installing the antimalware application
        $ADB install ../Antimalware/bin/Antimalware.apk
        $ADB $@
    fi
}

function testBenign {
    COUNT=0;
    ls $MODE/partition$PARTITION/B*apk | sort -R | while read APPLICATION; do
        if (( COUNT % 10 == 0  )); then # Not $COUNT
            ./flash-device.sh "$SERIAL"
        fi;

        monkeyTest $APPLICATION $DELAY
        let COUNT=COUNT+1
    done
}

function testMalicious {
    ls $MODE/partition$PARTITION/M*apk | sort -R | while read APPLICATION; do
        ./flash-device.sh "$SERIAL"
        monkeyTest $APPLICATION $DELAY
    done
}

#########
# Start #
#########

[[ $# == 3 || ( $1 == "Training" || $1 == "Testing" ) ]] || \
    die 1 "Usage: ./collect-data-device.sh <Testing/Training> <serial number> <partition number>"

msg Setting the mode to $1 for device $2
MODE=$1
SERIAL=$2
PARTITION=$3

ADB="adb -s $SERIAL "
FASTBOOT="fastboot -s $SERIAL "

msg Setting the event delay to 450 milliseconds
DELAY=450 # Random: $(( ($RANDOM % 1501) + 250 ))

testBenign
testMalicious

./flash-device.sh "$SERIAL"
$ADB shell input keyevent $ADB_POWER

exit 0
