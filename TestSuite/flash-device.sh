#!/bin/sh
#
# flash-device.sh
# Flashes a device and slightly configures it 
#
# Brandon Amos
# 2012.09.15

# Key events
UP=19
DOWN=20
CLICK=23

# sendKey <keyevent> <repetitions>
function sendKey {
    EVENT=$1
    REPS=$2

    for (( i=0; i<$REPS; i++ )); do
        $ADB shell input keyevent $EVENT
    done
}

#########
# Start #
#########

if [[ $# != 1 ]]; then
    echo "Usage: ./flash-device.sh <serial>"
    exit 1
fi

SERIAL=$1
ADB="adb -s $SERIAL "
FASTBOOT="fastboot -s $SERIAL "


# This could be easily changed to work for
# multiple devices
cd Device-Images/Crespo

echo Rebooting into the bootloader and flashing the device
$ADB reboot bootloader
$FASTBOOT flash boot boot.img
$FASTBOOT flash recovery recovery.img
$FASTBOOT flash system system.img
$FASTBOOT flash userdata userdata.img
$FASTBOOT reboot

echo Waiting for functionality
$ADB wait-for-device
sleep 90

# Configure settings
$ADB shell am start -a android.intent.action.MAIN \
    -n com.android.settings/.Settings

# Stay awake
sendKey $DOWN 19
sendKey $CLICK 1
sendKey $DOWN 2
sendKey $CLICK 1

cd ../..

exit 0
