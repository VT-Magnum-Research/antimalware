#!/bin/bash
#
# flash-device.sh
# Flashes a device and slightly configures it 
#
# Brandon Amos
# 2012.09.15

source helper.sh

function fd_flashDevice {
    msg Rebooting into the bootloader and flashing the device
    $ADB reboot bootloader
    $FASTBOOT flash boot boot.img
    $FASTBOOT flash recovery recovery.img
    $FASTBOOT flash system system.img
    $FASTBOOT flash userdata userdata.img
    $FASTBOOT reboot
}

function fd_waitForFunctionality {
    echo Waiting for functionality
    $ADB wait-for-device
    $ADB logcat | grep -q -m 1 "Boot is finished"
}

function fd_stayAwake {
    sendKey $ADB_DOWN 19
    sendKey $ADB_CLICK 1
    sendKey $ADB_DOWN 2
    sendKey $ADB_CLICK 1
    sendKey $ADB_BACK 3
}

function fd_configSettings {
    $ADB shell am start -a android.intent.action.MAIN \
        -n com.android.settings/.Settings
    fd_stayAwake
}

#########
# Start #
#########

# flashDevice <serial>
function flashDevice {
    [[ $# == 1 ]] || die 1 "Usage: ./flash-device.sh <serial>"

    SERIAL=$1
    ADB="adb -s $SERIAL "
    FASTBOOT="fastboot -s $SERIAL "

    cd_dir Device-Images/Crespo
    fd_flashDevice
    fd_waitForFunctionality
    fd_configSettings
    cd_dir ../..

    msg Installing the antimalware application
    $ADB install ../Antimalware/bin/Antimalware.apk
}
