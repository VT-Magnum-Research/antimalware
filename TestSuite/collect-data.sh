#!/bin/sh
#
# collect-data.sh
# Installs, tests, and uninstalls various apks for malware analysis.
#
# Brandon Amos
# 2012.08.10

# Combine and collect the separately collected arff files.
function collectArff {
    echo Combining and archiving the arff files
    cd ../arff/tmp
    mv ../$MODE.arff . &> /dev/null

    # Get the header from a random arff file
    sed '1,/@data/!d' `find . -name '*.arff' | head -1` > tmpTotal.txt

    # Loop through arff files to combine them
    for file in $(find . -name '*.arff')
    do
        # Delete the header
        sed '1,/@data/d' $file > tmpArff.txt

        # Delete the first line because it's always positive
        sed '1d' tmpArff.txt >> tmpTotal.txt
        echo >> tmpTotal.txt
    done

    rm -f tmpArff.txt $MODE.arff
    mv tmpTotal.txt ../$MODE.arff
}

#########
# Start #
#########

if [[ $# != 1 || ( $1 != "Training" && $1 != "Testing" ) ]]; then
    echo "Usage: ./collect-data.sh <Testing/Training>"
    exit 1
fi

echo Cleaning the tmp directory
rm -rf ../arff/tmp/*

# Get the mode we're currently running in
MODE=$1

./collect-data-device.sh $MODE 31306222A39C00EC &

# Wait for all of the backgrounded scripts to finish
wait ${!}

collectArff

exit 0
