#!/bin/bash
#
# helper.sh
# Provides extra functionality. 
#
# Brandon Amos
# 2012.11.22

# Key events
ADB_MENU=1
ADB_BACK=4
ADB_UP=19
ADB_DOWN=20
ADB_RIGHT=22
ADB_CLICK=23
ADB_POWER=26

function msg {
    echo " + $@"
}

function die {
    msg $2
    exit $1
}

# sendKey <keyevent> <repetitions>
function sendKey {
    EVENT=$1
    REPS=$2

    for (( i=0; i<$REPS; i++ )); do
        $ADB shell input keyevent $EVENT
    done
}

# installAndMonkeyTest <apk name> <delay>
function monkeyTest {
    if [[ $1 == *.apk ]]; then # System apps: *.sysapk
        msg Installing application $1
        adbTimeout install $1
    fi

    startAntimalware $1

    package=`aapt dump badging $1 | 
        grep -o "package: name='[^']*'" |
        cut -f2 -d \'`

    msg Monkey testing application $package
    $ADB shell monkey -p $package \
      --throttle $2 \
      --pct-syskeys 0 \
      --pct-anyevent 0 \
      -s `date +%s` \
      1200

    stopAntimalware $1
    
    if [[ $1 == *.apk ]]; then
        msg Uninstalling package $package
        adbTimeout uninstall $package
    fi
}

# startAntimalware <apk name>
function startAntimalware {
    msg Starting the antimalware application
    adbTimeout shell am start -a android.intent.action.MAIN \
        -n org.vt.magnum.antimalware.main/.MalwareActivity

    sleep 5

    if [[ $1 == $MODE/partition$PARTITION/M* ]]; then
        CLASS=negative
    else
        CLASS=positive
    fi

    msg Setting the classification to $CLASS
    adbTimeout shell "echo $CLASS > /sdcard/magnum/classification"
}

# stopAntimalware <apk name>
function stopAntimalware {
    msg "Pulling the arff for $1"
    adbTimeout pull /sdcard/magnum/malware.arff ../arff/$1.arff

    msg Stopping the antimalware application
    adbTimeout shell am force-stop "org.vt.magnum.antimalware.main"
}

