package org.vt.magnum.antimalware.features;

import java.util.ArrayList;
import weka.core.Attribute;
import weka.core.DenseInstance;
import weka.core.Instance;

//TODO: Incomplete
/**
 * Gets binder features by parsing /proc/binder/stats.
 * @author Brandon Amos
 * @version 2012.08.10
 */
public class BinderFeatures {
	private int _transaction;
	private int _reply;
	private int _acquire;
	private int _release;
	
	private int _activeNodes;
	private int _totalNodes;
	
	private int _activeRef;
	private int _totalRef;
	
	private int _activeDeath;
	private int _totalDeath;
	
	private int _activeTransaction;
	private int _totalTransaction;
	
	private int _activeTransactionComplete;
	private int _totalTransactionComplete;
	
	private int _totalNodesDiff;
	private int _totalRefDiff;
	private int _totalDeathDiff;
	private int _totalTransactionDiff;
	private int _totalTransactionCompleteDiff;
	
	private WekaHelper _wh;
	private FileParser _fp;
	private ArrayList<Attribute> _attributes;
	private Instance _instance;
	
	public BinderFeatures() {
		_wh = new WekaHelper();
		_fp = new FileParser();
		_attributes = _wh.createNumAttributeList(
				"binderTransaction", "binderReply", "binderAcquire", "binderRelease",
				"binderActiveNodes", "binderTotalNodes", "binderActiveRef",
				"binderTotalRef", "binderActiveDeath", "binderTotalDeath",
				"binderActiveTransaction", "binderTotalTransaction",
				"binderActiveTransactionComplete", "binderTotalTransactionComplete",
				"binderTotalNodesDiff", "binderTotalRefDiff", "binderTotalDeathDiff",
				"binderTotalTransactionDiff", "binderTotalTransactionCompleteDiff");
	}
	
	public void fetchData() {
		try
	    {
			int totalNodes = 0;
			int totalRef = 0;
			int totalDeath = 0;
			int totalTransaction = 0;
			int totalTransactionComplete = 0;
			
			//TODO: Verify this
			// Only present on emulators and devices in user-debug+ mode
			_fp.load( "/proc/binder/stats" );
			
			_transaction = _fp.readInt( 1, 1 );
			_reply = _fp.readInt( 2, 1 );
			
			_transaction = _fp.readInt( 1, 1 );
			
			_fp.load( "/proc/binder/stats" );
			_transaction = _fp.readInt( 1, 1 );
			
			_acquire = _fp.readInt( 5, 1 );
			_release = _fp.readInt( 6, 1 );
			
			_activeNodes = _fp.readInt( 24, 2 );
			totalNodes = _fp.readInt( 24, 4 );
			
			_activeRef = _fp.readInt( 25, 2 );
			totalRef = _fp.readInt( 25, 4 );
			
			_activeDeath = _fp.readInt( 26, 2 );
			totalDeath = _fp.readInt( 26, 4 );
			
			_activeTransaction = _fp.readInt( 27, 2 );
			totalTransaction = _fp.readInt( 27, 4 );
			
			_activeTransactionComplete = _fp.readInt( 28, 2 );
			totalTransaction = _fp.readInt( 28, 4 ); 
			
			_fp.close();
        	
        	_totalNodesDiff = totalNodes - _totalNodes;
        	_totalRefDiff = totalRef - _totalRef;
        	_totalDeathDiff = totalDeath - _totalDeath;
        	_totalTransactionDiff = totalTransaction - _totalTransaction;
        	_totalTransactionCompleteDiff = 
        			totalTransactionComplete - _totalTransactionComplete; 
	    }
	    catch( Exception ex )
	    {
	        ex.printStackTrace();           
	    }
	}
	
	public Instance getInstance() {
		fetchData();
		
		_wh.resetAttributes(_attributes);
		
		_instance = new DenseInstance(_attributes.size());
		
		_instance.setValue(_attributes.get(0), _transaction);
		_instance.setValue(_attributes.get(1), _reply);
		_instance.setValue(_attributes.get(2), _acquire);
		_instance.setValue(_attributes.get(3), _release);
		
		_instance.setValue(_attributes.get(4), _activeNodes);
		_instance.setValue(_attributes.get(5), _totalNodes);
		
		_instance.setValue(_attributes.get(6), _activeRef);
		_instance.setValue(_attributes.get(7), _totalRef);
		
		_instance.setValue(_attributes.get(8), _activeDeath);
		_instance.setValue(_attributes.get(9), _totalDeath);
		
		_instance.setValue(_attributes.get(10), _activeTransaction);
		_instance.setValue(_attributes.get(11), _totalTransaction);
		
		_instance.setValue(_attributes.get(12), _activeTransactionComplete);
		_instance.setValue(_attributes.get(13), _totalTransactionComplete);
		
		_instance.setValue(_attributes.get(14), _totalNodesDiff);
		_instance.setValue(_attributes.get(15), _totalRefDiff);
		_instance.setValue(_attributes.get(16), _totalDeathDiff);
		_instance.setValue(_attributes.get(17), _totalTransactionDiff);
		_instance.setValue(_attributes.get(18), _totalTransactionCompleteDiff);
	
		return _instance;
	}
	
	public ArrayList<Attribute> getAttributes() {
		return _attributes;
	}

}
