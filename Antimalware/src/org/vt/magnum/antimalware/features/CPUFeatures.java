package org.vt.magnum.antimalware.features;

import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ArrayList;

import weka.core.Attribute;
import weka.core.DenseInstance;
import weka.core.Instance;

/**
 * Gets CPU features by parsing top's output
 * @author Brandon Amos
 * @version 2012.08.10
 */
public class CPUFeatures implements IFeatures {	
    private int _cpuUser = 0;
    private int _cpuSystem = 0;
    private int _cpuIdle = 0;
    private int _cpuOther = 0;
    
	private ArrayList<Attribute> _attributes;
	private Instance _instance;
	
	private WekaHelper _wh;
	
	public CPUFeatures() {
		_wh = WekaHelper.getInstance();
		_attributes = new ArrayList<Attribute>();		
		_attributes.addAll(_wh.createNumAttributeList(
				"cpuUser", "cpuSystem", "cpuIdle", "cpuOther"));
	}
	
	// http://stackoverflow.com/questions/2467579/how-to-get-cpu-usage-statistics-on-android
	public void fetchData() {
	    String topOut = executeTop();
	    topOut = cleanTopStr(topOut);
	    int[] cpuUsage = extractTokens(topOut);
	    
	    _cpuUser = cpuUsage[0];
	    _cpuSystem = cpuUsage[1];
	    _cpuIdle = cpuUsage[2];
	    _cpuOther = cpuUsage[3];
	}
	
	public Instance getInstance() {
		fetchData();
		
		_wh.resetAttributes(_attributes);
		
		_instance = new DenseInstance(_attributes.size());
		_instance.setValue(_attributes.get(0), _cpuUser);
		_instance.setValue(_attributes.get(1), _cpuSystem);
		_instance.setValue(_attributes.get(2),  _cpuIdle);
		_instance.setValue(_attributes.get(3), _cpuOther);
	
		return _instance;
	}
	
	public ArrayList<Attribute> getAttributes() {
		return _attributes;
	}

	private String executeTop() {
	    java.lang.Process p = null;
	    BufferedReader in = null;
	    String topOut = "";
	    try {
	        p = Runtime.getRuntime().exec("top -n 1");
	        in = new BufferedReader(new InputStreamReader(p.getInputStream()));
	        while (topOut == null || topOut.contentEquals("")) {
	            topOut = in.readLine();
	        }
	    } catch (IOException e) {
	    } finally {
	        try {
	            in.close();
	            p.destroy();
	        } catch (IOException e) { }
	    }
	    return topOut;
	}
	
	private String cleanTopStr(String str) {
		str = str.replaceAll(",", "");
	    str = str.replaceAll("User", "");
	    str = str.replaceAll("System", "");
	    str = str.replaceAll("IOW", "");
	    str = str.replaceAll("IRQ", "");
	    str = str.replaceAll("%", "");
	    for (int i = 0; i < 10; i++) {
	        str = str.replaceAll("  ", " ");
	    }
	    str = str.trim();
	    return str;
	}
	
	private int[] extractTokens(String str) {
		int[] cpuUsage = new int[4];
		String[] topOutToks = str.split(" ");
	    
	    for (int i = 0; i < 4; i++) {
	        topOutToks[i] = topOutToks[i].trim();
	        cpuUsage[i] = Integer.parseInt(topOutToks[i]);
	    }
	    return cpuUsage;
	}
}
