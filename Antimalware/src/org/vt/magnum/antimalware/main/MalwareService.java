package org.vt.magnum.antimalware.main;

import java.util.ArrayList;
import java.util.List;
import java.util.concurrent.Executors;
import java.util.concurrent.ScheduledExecutorService;
import java.util.concurrent.TimeUnit;

import org.vt.magnum.antimalware.features.BatteryFeatures;
import org.vt.magnum.antimalware.features.BinderFeatures;
import org.vt.magnum.antimalware.features.CPUFeatures;
import org.vt.magnum.antimalware.features.MemoryFeatures;
import org.vt.magnum.antimalware.features.NetworkFeatures;
import org.vt.magnum.antimalware.features.WekaHelper;

import weka.core.Attribute;
import weka.core.DenseInstance;
import weka.core.Instance;
import weka.core.Instances;

import android.app.Service;
import android.content.Intent;
import android.content.IntentFilter;
import android.os.Binder;
import android.os.IBinder;
import android.text.format.Time;
import android.util.Log;

/**
 * This collects the vectors
 * and periodically writes them to a file (if training
 * mode is enabled).
 * 
 * @author Brandon Amos
 * @version 2012.08.10
 */
public class MalwareService extends Service {
	private static final String TAG = "MalwareService";
	
	private final IBinder mBinder = new MalwareBinder();
	private Time time;
	private ScheduledExecutorService scheduledExecutor;
	
	private BatteryFeatures battFeatures;
	private BinderFeatures binderFeatures;
	private CPUFeatures cpuFeatures;
	private MemoryFeatures memoryFeatures;
	private NetworkFeatures networkFeatures;

	private WekaHelper wh;
	private ArrayList<Attribute> battAttributes;
	private ArrayList<Attribute> binderAttributes;
	private ArrayList<Attribute> cpuAttributes;
	private ArrayList<Attribute> memoryAttributes;
	private ArrayList<Attribute> networkAttributes;
	private ArrayList<Attribute> classAttributes;
	private ArrayList<Attribute> attributes;
	private Instances instances;
	
	@Override
	public void onCreate() {
		time = new Time();
		
		battFeatures = new BatteryFeatures();
		binderFeatures = new BinderFeatures();
		cpuFeatures = new CPUFeatures();
		memoryFeatures = new MemoryFeatures();
		networkFeatures = new NetworkFeatures();
		
		wh = new WekaHelper();
		
		initWeka();
		initExecutor();
	}
	
	@SuppressWarnings("unchecked")
	private void initWeka() {
		battAttributes = battFeatures.getAttributes();
		binderAttributes = binderFeatures.getAttributes();
		cpuAttributes = cpuFeatures.getAttributes();
		memoryAttributes = memoryFeatures.getAttributes();
		networkAttributes = networkFeatures.getAttributes();
		
		classAttributes = new ArrayList<Attribute>();

		List<String> classVal = new ArrayList<String>(2);
		classVal.add("positive");
		classVal.add("negative");
		Attribute classAttribute = new Attribute("classification", classVal);
		classAttributes.add(classAttribute);
		
		attributes = wh.addLists(battAttributes, binderAttributes, 
				cpuAttributes, memoryAttributes, networkAttributes,
				classAttributes);
		instances = new Instances("relation", attributes, 0);
	}

	/**
	 * Sets up retrieval at a fixed interval.
	 */
	private void initExecutor() {
		//TODO: Use a better way of checking for data at a set interval.
		// It might be a good idea to make a service and put it to sleep for
		// its idle time, or to use another kind of service? Perhaps an 
		// IntentService?
		scheduledExecutor = Executors.newScheduledThreadPool(1);
		
		scheduledExecutor.scheduleAtFixedRate(new Runnable() {
			public void run() {
				fetchSnapshot();
			}
		}, 1, 5, TimeUnit.SECONDS); 
	}
	
	@Override
	public IBinder onBind(Intent intent) {
		return mBinder;
	}
	
	@Override
	public boolean onUnbind(Intent intent) {
		return true;
	}
	
	/**
	 * Gets the data from all of the features and puts them in 
	 * a format for Weka to read.
	 */
	public void fetchSnapshot() {
		Log.d(TAG, "fetchSnapshot!");
		
		time.setToNow();
		
		IntentFilter filter = new IntentFilter(Intent.ACTION_BATTERY_CHANGED);
		Instance battInstances = battFeatures.getInstance(registerReceiver(null, filter));
		
		
		Instance binderInstances = binderFeatures.getInstance();
		Instance cpuInstances = cpuFeatures.getInstance();
		Instance memoryInstances = memoryFeatures.getInstance();
		Instance networkInstances = networkFeatures.getInstance();
		
		wh.resetAttributes(classAttributes);
		Instance classInstance = new DenseInstance(1);
		classInstance.setValue(
				classAttributes.get(0), wh.getClassification() );
		
		wh.resetAttributes(attributes);
		instances.add(wh.mergeInstances(
				battInstances, binderInstances, cpuInstances,
				memoryInstances, networkInstances, classInstance));
		instances.setClassIndex(attributes.size()-1);
		
		wh.writeArff(instances.toString());
	}
	
	public class MalwareBinder extends Binder {
		MalwareService getService() {
			return MalwareService.this;
		}
	}
}
