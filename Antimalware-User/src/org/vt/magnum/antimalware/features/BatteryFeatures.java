package org.vt.magnum.antimalware.features;

import java.util.ArrayList;
import java.util.List;

import weka.core.Attribute;
import weka.core.DenseInstance;
import weka.core.Instance;
import android.content.Intent;
import android.os.BatteryManager;

/**
 * Gets battery features by using the BatteryManager class.
 * @author Brandon Amos
 * @version 2012.08.10
 */
public class BatteryFeatures implements IFeatures {
	private Intent _intent;
	
	private boolean _isCharging = false;
	private int _voltage = 0;
	private int _temp = 0;
	private double _level = 0;
	private double _levelDiff = 0;
	//TODO: Try to get the current?
	
	private ArrayList<Attribute> _attributes;
	private Instance _instance;
	
	private WekaHelper _wh;
	
	public BatteryFeatures() {
		_wh = WekaHelper.getInstance();
		_attributes = new ArrayList<Attribute>();
		
		// Create the feature vector
		List<String> battIsChargingList = new ArrayList<String>(2);
		battIsChargingList.add("true");
		battIsChargingList.add("false");
		Attribute battIsCharging = 
				new Attribute("battIsCharging", battIsChargingList);
		_attributes.add(battIsCharging);
		
		_attributes.addAll(_wh.createNumAttributeList(
				"battVoltage", "battTemp",
				"battLevel", "battLevelDiff"));
	}
	
	
	
	public Instance getInstance() {
		fetchData();
		
		_wh.resetAttributes(_attributes);
		
		_instance = new DenseInstance(_attributes.size());
		_instance.setValue(_attributes.get(0), _isCharging ? "true" : "false");
		_instance.setValue(_attributes.get(1), _voltage);
		_instance.setValue(_attributes.get(2), _temp);
		_instance.setValue(_attributes.get(3), _level);
		_instance.setValue(_attributes.get(4), _levelDiff);
		// instance.setValue(attributes.get(2), _current);
	
		return _instance;
	}
	
	public void fetchData() {
		boolean isCharging = false;
		int voltage = -1;
		// int current = -1; //TODO: Get the current?
		int temp = -1;
		double level = -1;
		
		int status = _intent.getIntExtra(BatteryManager.EXTRA_STATUS, -1);
		
		isCharging = status == BatteryManager.BATTERY_STATUS_CHARGING ||
				status == BatteryManager.BATTERY_STATUS_FULL;
		
		voltage = _intent.getIntExtra(BatteryManager.EXTRA_VOLTAGE, -1);
		temp = _intent.getIntExtra(BatteryManager.EXTRA_TEMPERATURE, -1);
		
		
		int scale = _intent.getIntExtra(BatteryManager.EXTRA_SCALE, -1);
		level = (double) _intent.getIntExtra(BatteryManager.EXTRA_LEVEL, -1)/scale * 100;
		
		_isCharging = isCharging;
		_voltage = voltage;
		_temp = temp;
		_levelDiff = level - _level;
		_level = level;
	}
	
	public void setIntent(Intent intent) {
		_intent = intent;
	}
	
	public ArrayList<Attribute> getAttributes() {
		return _attributes;
	}
}
