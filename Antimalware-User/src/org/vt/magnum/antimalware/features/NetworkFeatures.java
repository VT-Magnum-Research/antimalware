package org.vt.magnum.antimalware.features;

import java.util.ArrayList;

import weka.core.Attribute;
import weka.core.DenseInstance;
import weka.core.Instance;
import android.net.TrafficStats;

/**
 * Gets networking features via the TrafficStats class.
 * @author Brandon Amos
 * @version 2012.08.10
 */
public class NetworkFeatures implements IFeatures {
	private long _totalTXPackets;
	private long _totalTXBytes;
	private long _totalRXPackets;
	private long _totalRXBytes;
	
	private long _totalTXPacketsDiff;
	private long _totalTXBytesDiff;
	private long _totalRXPacketsDiff;
	private long _totalRXBytesDiff;
	
	private ArrayList<Attribute> _attributes;
	private Instance _instance;
	
	private WekaHelper _wh;
	
	public NetworkFeatures() {
		_wh = WekaHelper.getInstance();
		_attributes = new ArrayList<Attribute>();
		
		// Create the feature vector		
		_attributes.addAll(_wh.createNumAttributeList(
				"networkTotalTXPackets", "networkTotalTXBytes", 
				"networkTotalRXPackets", "networkTotalRXBytes",
				"networkTotalTXPacketsDiff", "networkTotalTXBytesDiff", 
				"networkTotalRXPacketsDiff", "networkTotalRXBytesDiff" ));
	}
	
	public void fetchData() {
		// -1 (TrafficStats.UNSUPPORTED) is returned if the operation isn't supported
		long totalTXPackets = TrafficStats.getTotalTxPackets();
		long totalTXBytes = TrafficStats.getTotalTxBytes();
		long totalRXPackets = TrafficStats.getTotalRxPackets();
		long totalRXBytes = TrafficStats.getTotalRxBytes();
		
		_totalTXPacketsDiff = totalTXPackets - _totalTXPackets;
		_totalTXBytesDiff = totalTXBytes - _totalTXBytes;
		_totalRXPacketsDiff = totalRXPackets - _totalRXPackets;
		_totalRXBytesDiff = totalRXBytes - _totalRXBytes;
		
		_totalTXPackets = totalTXPackets;
		_totalTXBytes = totalTXBytes;
		_totalRXPackets = totalRXPackets;
		_totalRXBytes = totalRXBytes;
	}
	
	public Instance getInstance() {
		fetchData();
		
		_wh.resetAttributes(_attributes);
		
		_instance = new DenseInstance(_attributes.size());
		_instance.setValue(_attributes.get(0), _totalTXPackets);
		_instance.setValue(_attributes.get(1), _totalTXBytes);
		_instance.setValue(_attributes.get(2), _totalRXPackets);
		_instance.setValue(_attributes.get(3), _totalRXBytes);
		_instance.setValue(_attributes.get(4), _totalTXPacketsDiff);
		_instance.setValue(_attributes.get(5), _totalTXBytesDiff);
		_instance.setValue(_attributes.get(6), _totalRXPacketsDiff);
		_instance.setValue(_attributes.get(7), _totalRXBytesDiff);

		return _instance;
	}
	
	public ArrayList<Attribute> getAttributes() {
		return _attributes;
	}
}
